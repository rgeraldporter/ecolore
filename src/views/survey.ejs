<!DOCTYPE html>
<html lang="en">

        <% include head %>

        <%
            const hasLineBreaks = text => (text.match(/\n/g)||[]).length;
            const toUrl = text => locals.isUrl(text) ? md.render(`[${text}](${text})`) : text;
            const toMd = text => hasLineBreaks(text) ? md.render(text) : toUrl(text);
            const projectTypeSettings = locals.R.pathOr({}, ['projectSettings', project.model, 'surveys'], locals);
            const doNotReviewObservationCount = projectTypeSettings.doNotReviewObservationCount || false;
            const noLineBasedReviews = projectTypeSettings.noLineBasedReviews;

            const detectField = ({key, data}) => key === 'zone' ? survey.Zone.name : data[key];
            const noData = () => '[no data]';
            const detectType = (key, data) => {

                const condTable = ([key, data]) => [
                    [!isNaN(data[key]), detectField, {key, data}],
                    [typeof data[key] === 'string', toMd, data[key]],
                    [true, noData, null]
                ];

                const result = condTable([key, data]).find(a => a[0]);
                return result[1](result[2]);
            };

        %>

<body>
        <% include menu %>
        <div class="content-wrapper">
            <div class="header">

            </div>
            <div class="content pure-g">
            <% include project-menu %>
            <% const isAdmin = project.memberRole === 'administrator' || project.memberRole === 'owner'; %>
            <% const isContrib = project.memberRole === 'administrator' || project.memberRole === 'owner'
            || project.memberRole === 'contributor'; %>
            <main class="pure-u-1 pure-u-md-3-5">
                    <h2><%- review ? 'Review ' : '' %>Data: <%= locals.t('Survey', project) %> <%= survey.id %></h2>
                    <% if(isContrib) { %>
                        <a href="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/observation/new">Add <%= locals.t('observation', project) %></a><br>
                    <% } %>
                    <a href="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/surveys">Return to <%= locals.t('surveys', project) %> for <%= survey.Cycle.title  %></a>
            <form action="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/review" method="POST"  class="pure-form pure-form-aligned">
            <% if(review && !noLineBasedReviews) { %>
                    <p>When in review, each row must be checked off as correct, before you can submit it as passed.</p>
                <% } %>
            <% if (survey.get('reviewCount')) { %>
            <a href="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/reviews">Show all <%= survey.get('reviewCount') %> reviews</a>
            <% } else { %>
            No reviews yet. <a href="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/review">
                Add a review
            </a>
            <% } %>
            <table class="pure-table pure-table-horizontal">
                <thead>
                    <tr><th>Row</th><th>Value</th><%- review && !noLineBasedReviews ? '<th>Correct?</th>' : '' %></tr>
                </thead>
                <tbody>
                <%
                    const data = JSON.parse(survey.data);
                    Object.keys(data).forEach(key => {
                %>
                    <tr>
                        <td><%= key %></td>
                        <td><%- detectType(key,data) %></td>
                        <% if (review && !noLineBasedReviews) { %>
                            <td>
                                <input type="checkbox" required>
                            </td>
                        <% } %>
                    </tr>
                <% }); %>
                    <tr>
                        <td><%= locals.t('observations', project) %></td>
                        <td><a <%= review ? 'target="_blank" ' : '' %> href="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/observations">Show all <%= survey.get('observationCount') %> <%= locals.t('observations', project) %> <%= review ? '(opens new window)' : '' %></a></td>
                        <% if (review && ! doNotReviewObservationCount) { %>
                            <td>
                                <input type="checkbox" required>
                            </td>
                        <% } %>
                    </tr>
              </tbody>
            </table>
            <% if (review) { %>
                <p>Your name and time of review will be recorded when you complete your review.</p>
                <fieldset>
                    <div class="pure-control-group">
                        <label for="form-invitees">Review Notes</label>
                        <textarea rows="6" cols="35" name="comments" placeholder="Enter comments here (optional)"></textarea>
                    </div>
                </fieldset>
                <% if (noLineBasedReviews) { %>
                <fieldset>
                        <div class="pure-control-group">
                            <label for="comment-submit"></label>
                            <button type="submit" name="submitComment" value="1" class="pure-button pure-button-primary" id="comment-submit">Submit comment</button>
                        </div>
                </fieldset>
                <% } %>
                <fieldset>
                    <div class="pure-control-group">
                        <% if (noLineBasedReviews) { %>
                        <label for="pass-submit">Passing the review will also submit your comments</label>
                        <% } else { %>
                            <label for="pass-submit"></label>
                        <% } %>
                        <button type="submit" class="pure-button pure-button-primary button-success" id="pass-submit">Pass review</button>
                    </div>
                </fieldset>
            <% } %>
            </form>
            <% if (review) { %>
                <form action="/project/<%= project.slug %>/cycle/<%= survey.Cycle.id %>/survey/<%= survey.id %>/review" method="POST" class="pure-form pure-form-aligned">
                    <fieldset>
                        <input type="hidden" value="1" name="invalidate">
                        <div class="pure-control-group">
                            <label for="invalidate-submit"></label>
                            <button type="submit" class="pure-button button-error" id="invalidate-submit">Invalidate and resubmit data</button>
                        </div>
                    </fieldset>
                </form>
            <% } %>
            </main>
        </div>
        <% include footer %>
    </div>
</body>

</html>